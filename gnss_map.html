<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GNSS Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    /* Style for the auto-center control when active */
    .active-center {
      background-color: #0078A8;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Initialize map and layers
    var map = L.map('map').setView([0.0, 0.0], 2);
    // Online satellite imagery layer (Esri World Imagery)
    // Use Esri's World Imagery service as the default base map so users see satellite
    // imagery instead of the standard OpenStreetMap tiles.  The curly braces are
    // doubled to escape them in the Python f-string.
    var online = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics' }).addTo(map);
    // Offline tile layer (not added by default)
    var offline = L.tileLayer('tiles/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Offline tiles' });
    // Current position marker
    var marker = L.marker([0.0, 0.0]).addTo(map);
    // History of visited points
    var history = [];
    // Whether the map should automatically center on the current position.
    // By default this is false; the user can toggle it via a custom control.
    var autoCenter = false;
    // ---------------------------------------------------------------------
    // Dataset layer storage and control.  The unified map needs to display
    // static datasets loaded from files alongside the real‑time GNSS marker.
    // Each dataset is stored in the `datasetLayers` object so that it can be
    // removed or toggled via the Leaflet layer control.  A base layer
    // dictionary defines the online and offline tile layers.
    var datasetLayers = {};
    var baseLayers = { 'Satellite': online, 'Offline': offline };
    // The controlLayers object will manage overlays for datasets.  The
    // `collapsed: false` option keeps the control expanded by default.
    var controlLayers = L.control.layers(baseLayers, {}, { collapsed: false }).addTo(map);
    /**
     * Remove all previously added dataset layers from the map and the control.
     * Called from Python before new datasets are added.
     */
    function clearDatasets() {
      for (var name in datasetLayers) {
        var layer = datasetLayers[name];
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
        try {
          controlLayers.removeLayer(layer);
        } catch (e) {
          // ignore missing layer
        }
      }
      datasetLayers = {};
    }
    /**
     * Add a new dataset to the map.
     * @param {string} name  Dataset name to appear in the layer control
     * @param {Array} points Array of [lat, lon, tooltip, popup] entries
     * @param {string} color Hex colour code for markers
     */
    function addDataset(name, points, color) {
      // Use a feature group so that we can compute bounds when toggling layers.
      var layer = L.featureGroup();
      for (var i = 0; i < points.length; i++) {
        var pt = points[i];
        var lat = pt[0], lon = pt[1];
        var tooltip = (pt.length > 2 ? pt[2] : null);
        var popup = (pt.length > 3 ? pt[3] : null);
        var circle = L.circleMarker([lat, lon], { radius: 3, color: color, fillColor: color, fillOpacity: 0.8 });
        if (tooltip) {
          circle.bindTooltip(tooltip);
        }
        if (popup) {
          circle.bindPopup(popup);
        }
        circle.addTo(layer);
      }
      layer.addTo(map);
      datasetLayers[name] = layer;
      controlLayers.addOverlay(layer, name);
      // When the user toggles this overlay via the layer control, recenter the map
      // on the bounds of the dataset.  Use the overlayadd event to detect when
      // the layer is added to the map.
      map.on('overlayadd', function(e) {
        if (e.layer === layer) {
          var b = layer.getBounds();
          if (b && b.isValid && b.isValid()) {
            map.fitBounds(b);
          }
        }
      });
    }
    /**
     * Helper to move the main marker to a new location and optionally recenter the map.
     * @param {number} lat Latitude in decimal degrees
     * @param {number} lon Longitude in decimal degrees
     */
    function updateMarker(lat, lon) {
      // Move the main marker
      marker.setLatLng([lat, lon]);
      // Recenter the map only if autoCenter is enabled
      if (autoCenter) {
        map.setView([lat, lon]);
      }
    }
    /**
     * Update the current position on the map and record it in the history.
     * This calls updateMarker internally and adds a small circle marker for logging.
     * @param {number} lat  Latitude in decimal degrees
     * @param {number} lon  Longitude in decimal degrees
     * @param {string} info Tooltip content shown when hovering over the history point
     */
    function updatePosition(lat, lon, info) {
      // Always update the main marker and conditionally recenter
      updateMarker(lat, lon);
      // Create a small red circle at the given location
      var pt = L.circleMarker([lat, lon], { radius: 4, color: 'red', fillColor: 'red', fillOpacity: 0.8 }).addTo(map);
      if (info) {
        // Attach a tooltip for hover display; tooltips show on mouseover by default
        pt.bindTooltip(info);
      }
      history.push(pt);
    }
    /**
     * Get current bounds of the map as [south, north, west, east].
     */
    function getBounds() {
      var b = map.getBounds();
      return [b.getSouth(), b.getNorth(), b.getWest(), b.getEast()].join(',');
    }
    /**
     * Create a control button to toggle automatic centering on the user's position.
     * The button is inactive by default.  Clicking it toggles autoCenter and updates its style.
     */
    var centerControl = L.control({position: 'topleft'});
    centerControl.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
      var button = L.DomUtil.create('a', '', div);
      button.href = '#';
      button.title = 'Toggle auto-center';
      // Use a simple icon for the button; Unicode target symbol
      // Use a location pin icon for the auto-center button to make its purpose clearer.
      button.innerHTML = '&#x1F4CD;';
      function updateStyle() {
        if (autoCenter) {
          L.DomUtil.addClass(button, 'active-center');
        } else {
          L.DomUtil.removeClass(button, 'active-center');
        }
      }
      updateStyle();
      L.DomEvent.on(button, 'click', L.DomEvent.stopPropagation)
                .on(button, 'click', L.DomEvent.preventDefault)
                .on(button, 'click', function() {
                  autoCenter = !autoCenter;
                  // If enabling, immediately recenter the map on the current marker location
                  if (autoCenter) {
                    var loc = marker.getLatLng();
                    map.setView(loc);
                  }
                  updateStyle();
                });
      return div;
    };
    centerControl.addTo(map);
  </script>
</body>
</html>
